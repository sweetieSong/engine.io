<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" type="text/css" href="mocha.css" />
    <script type="text/javascript" src="http://redsky.cs.cornell.edu/expect.js"></script>
    <script type="text/javascript" src="http://redsky.cs.cornell.edu/eio-test.js"></script>
    
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript">
      var eoic, expect, Mocha, mocha;

      // expect.js does not have a component. try/catch here to fix for browser test
      try {
        expect = require("expect.js");
      } catch (err) {
      
      }

      // include engine.io-client (because component packages it differently, need try/catch)
      try {
        eioc = require('engine.io-client');
      } catch (err){
        eioc = require('LearnBoost-engine.io-client');
      }
    
      try {
        Mocha = require('mocha');
      } catch (err){
        Mocha = require('visionmedia-mocha');
      }
      
      // when we run in browser, module is 'undefined'
      if ('undefined' == typeof module) {
        var module = { exports: {} }
          , exports = module.exports;
      }
    
      process.stdout.write = function(content){
        window.mochaResults = JSON.parse(content);
        failures = window.mochaResults.failures;

        window.mochaResults.failures = failures.length==0?undefined:failures;
        window.mochaResults.failed = window.mochaResults.failures;
      }

    </script>

    <script type="text/javascript">
      mocha.setup('bdd')
    </script>
    <script src="prelims/json_fail.js"></script>
    <script src="prelims/json.js"></script>
    <script src="prelims/json_fail.js"></script>
    <script>

    onload = function(){
      //var runner = mocha.reporter('json').run();
      // runner.globals(['foo', 'bar', 'baz']);

      var runner = mocha.run();

      var failed = [];
      runner.on('fail', function(test, err){
        var fail = {
          title: test.title,
          fullTitle: test.fullTitle(),
          error: {
            message: err.message,
            stack: err.stack
          }
        };

        var oscpu = navigator.oscpu;
        var vendorSub = navigator.vendorSub;
        var vendor = navigator.vendor;

        var url = "browserName="+ encodeURIComponent(vendor) + 
                  "&browserVersion=" + encodeURIComponent(vendorSub) + 
                  "&browserPlatform=" + encodeURIComponent(oscpu) +
                  "&fullTitle=" + encodeURIComponent(fail.fullTitle) + 
                  "&message=" + encodeURIComponent(fail.error.message) + 
                  "&stack=" + encodeURIComponent(fail.error.stack);
        console.log(url);

        failed.push(fail);
        $("body").append("<img src=\"" + url + "\" />");
      });

      runner.on('end', function(){
        runner.stats.failed = failed;
        window.mochaResults = runner.stats;
      });
      
      // runner.on('test end', function(test){
      //   console.log(test.fullTitle());
      // });
    };
    </script>

  </head>

  <body>
    <div id="mocha"></div>
  </body>
</html>
